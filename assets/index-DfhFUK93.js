var e=Object.defineProperty,t=t=>{let n={};for(var r in t)e(n,r,{get:t[r],enumerable:!0});return n};(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var n=class{seed;constructor(e){this.seed=e>>>0}next(){let e=this.seed>>>0;return e^=e<<13,e>>>=0,e^=e>>17,e>>>=0,e^=e<<5,e>>>=0,this.seed=e>>>0,this.seed}nextFloat(){return this.next()/4294967295}shuffleInPlace(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(this.nextFloat()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}};function r(e){return e===`H`||e===`D`?`red`:`black`}function i(){let e=[`H`,`D`,`C`,`S`],t=[];for(let n of e)for(let e=1;e<=13;e++)t.push({id:`${n}${e}#0`,suit:n,rank:e,color:r(n)});return t}var a=t({dealFreeCellInitialState:()=>l,getFreeCellLevelConfig:()=>o});function o(e){switch(e){case 1:return{freecellSlots:4};case 2:return{freecellSlots:4};case 3:return{freecellSlots:3};default:return{freecellSlots:4}}}function s(e,t){let n=Array.from({length:8},()=>[]);for(let t=0;t<e.length;t++)n[t%8].push(e[t]);let r=Array.from({length:t},()=>null);return{columns:n,freecells:r,foundations:[[],[],[],[]]}}function c(e,t,n){let r=t.filter(e=>e.rank<=10),i=t.filter(e=>e.rank>=11);if(r.length<24||i.length<12)return s(t,n);let a=r.slice(),o=i.slice();e.shuffleInPlace(a),e.shuffleInPlace(o);let c=[];for(let e=0;e<8;e++)c.push(a.splice(0,3));let l=a.concat(o);e.shuffleInPlace(l);let u=Array.from({length:8},()=>[]);for(let e=0;e<8;e++){let n=e<4?7:6,r=Math.max(0,n-3);if(l.length<r){let e=r-l.length;l=l.concat(t.slice(0,e))}u[e]=l.splice(0,r).concat(c[e])}let d=Array.from({length:n},()=>null);return{columns:u,freecells:d,foundations:[[],[],[],[]]}}function l(e,t){let r=new n(e>>>0),a=i();r.shuffleInPlace(a);let{freecellSlots:l}=o(t);return t===1?c(r,a,l):s(a,l)}var u=t({dealKlondikeInitialState:()=>m});function d(e){let t=e>>>0;return function(){t+=1831565813;let e=t;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function f(e,t){for(let n=e.length-1;n>0;n--){let r=t()*(n+1)|0,i=e[n];e[n]=e[r],e[r]=i}}function p(){let e=[`H`,`D`,`C`,`S`],t=[];for(let n of e)for(let e=1;e<=13;e++)t.push({rank:e,suit:n,faceUp:!1});return t}function m(e,t){let n=d(e),r=p();f(r,n);let i=[];for(let e=0;e<7;e++){let t=e+1,n=[];for(let e=0;e<t;e++){let e=r.pop();if(!e)break;n.push({rank:e.rank,suit:e.suit,faceUp:!1})}i.push(n)}for(let e=0;e<i.length;e++){let n=i[e],r=n.length;r&&(n[r-1].faceUp=!0,t===1&&r>=2&&(n[r-2].faceUp=!0))}let a=t>=3?3:1;return{stock:r.map(e=>({rank:e.rank,suit:e.suit,faceUp:!1})),waste:[],foundations:[[],[],[],[]],tableaus:i,drawCount:a}}var h=t({dealSpiderGame:()=>y});function g(e){let t=e>>>0;return function(){return t^=t<<13,t>>>=0,t^=t>>17,t>>>=0,t^=t<<5,t>>>=0,t/4294967296}}function _(e,t){for(let n=e.length-1;n>0;n--){let r=t()*(n+1)|0,i=e[n];e[n]=e[r],e[r]=i}}function v(e){let t;t=e<=1?[`S`]:e===2?[`S`,`H`]:[`S`,`H`,`D`,`C`];let n=Math.floor(104/(13*t.length)),r=[];for(let e of t)for(let t=0;t<n;t++)for(let t=1;t<=13;t++)r.push({rank:t,suit:e,faceUp:!1});return r}function y(e,t){let n=g(e),r=v(t);_(r,n);let i=Array.from({length:10},()=>[]);for(let e=0;e<10;e++){let t=e<4?6:5;for(let n=0;n<t;n++){let a=r.pop();if(!a)throw Error(`Spider配布中にデッキが尽きました`);n===t-1&&(a.faceUp=!0),i[e].push(a)}}return{columns:i,stock:r,completedStacks:0}}function ee(e){for(let t of[`dealFreeCellGame`,`dealFreecellGame`,`dealFreeCellInitialState`,`dealFreecellInitialState`,`initFreeCellGame`,`initFreecellGame`,`initFreecell`,`dealFreeCell`,`dealFreecell`])if(typeof e[t]==`function`)return e[t];throw Error(`freecellの初期化関数が見つかりませんでした。deal/freecell側のexport名をご確認ください。`)}function te(e){for(let t of[`dealKlondikeGame`,`dealKlondikeInitialState`,`initKlondikeGame`,`initKlondike`,`dealKlondike`])if(typeof e[t]==`function`)return e[t];throw Error(`klondikeの初期化関数が見つかりませんでした。deal/klondike側のexport名をご確認ください。`)}function b(e){for(let t of[`dealSpiderGame`,`initSpiderGame`,`dealSpiderInitialState`,`initSpider`])if(typeof e[t]==`function`)return e[t];throw Error(`spiderの初期化関数が見つかりませんでした。deal/spider側のexport名をご確認ください。`)}var x=class{mode;level;seed;turnIndex;state;undoStack;moveLog;constructor(e,t,n){if(this.mode=e,this.level=t,this.seed=n,this.turnIndex=0,e===`freecell`)this.state=ee(a)(n,t);else if(e===`klondike`)this.state=te(u)(n,t);else if(e===`spider`)this.state=b(h)(n,t);else throw Error(`未実装モード: `+e);this.undoStack=[],this.moveLog=[]}snapshot(){let e=JSON.parse(JSON.stringify(this.state));this.undoStack.push({state:e,turnIndex:this.turnIndex})}undo(){let e=this.undoStack.pop();return e?(this.state=e.state,this.turnIndex=e.turnIndex,!0):!1}recordMove(e){e!=null&&this.moveLog.push(e)}buildClearReport(e){return{mode:this.mode,level:this.level,seed:this.seed,finalized:e,moveCount:this.moveLog.length,moves:this.moveLog.slice(),finalState:JSON.parse(JSON.stringify(this.state)),timestamp:Date.now()}}};function S(e){switch(e){case`H`:return 0;case`D`:return 1;case`C`:return 2;case`S`:return 3}}function C(e,t){let n=S(t),r=e.foundations[n];return!r||r.length===0?1:r[r.length-1].rank+1}function w(e,t){return t.rank===C(e,t.suit)}function ne(e,t){if(e===null)return!0;let n=e.color!==t.color,r=t.rank===e.rank-1;return n&&r}function re(e){return e.freecells.reduce((e,t)=>e+(t===null?1:0),0)}function ie(e){return e.columns.reduce((e,t)=>e+(t.length===0?1:0),0)}function T(e){let t=re(e),n=ie(e);return(t+1)*2**n}function E(e,t,n){let r=e.columns[t];if(!r||n<0||n>=r.length)return[];let i=[r[n]];for(let e=n+1;e<r.length;e++){let t=i[i.length-1],n=r[e],a=t.color!==n.color,o=t.rank===n.rank+1;if(a&&o)i.push(n);else break}return n+i.length===r.length?i:[]}function ae(e,t,n){let r=T(e);if(t.type===`column`){if(t.index===void 0)return{ok:!1,reason:`column indexなし`};let i=t.index,a=e.columns[i];if(!a||a.length===0)return{ok:!1,reason:`列が空`};let o=t.startIndex===void 0?a.length-1:t.startIndex,s=E(e,i,o);if(s.length===0)return{ok:!1,reason:`その位置のスタックは動かせない`};if(s.length>r)return{ok:!1,reason:`スタックが大きすぎる`};let c=s;if(n.type===`column`){if(n.index===void 0)return{ok:!1,reason:`to column indexなし`};let t=e.columns[n.index],r=t&&t.length>0?t[t.length-1]:null,a=c[0];return ne(r,a)?{ok:!0,cards:c,fromDetail:{type:`column`,colIndex:i,startIndex:o},toDetail:{type:`column`,colIndex:n.index},actionType:c.length>1?`MOVE_STACK`:`MOVE_CARD`}:{ok:!1,reason:`列に置けない`}}if(n.type===`freecell`){if(n.index===void 0)return{ok:!1,reason:`to freecell indexなし`};if(e.freecells[n.index]!==null)return{ok:!1,reason:`freecell埋まってる`};let t=a.length-1;return o===t?{ok:!0,cards:[c[0]],fromDetail:{type:`column`,colIndex:i,startIndex:o},toDetail:{type:`freecell`,freecellIndex:n.index},actionType:`MOVE_CARD`}:{ok:!1,reason:`freecellへは一番下の1枚だけ`}}if(n.type===`foundation`){let t=a.length-1;if(o!==t)return{ok:!1,reason:`foundationへは一番下の1枚だけ`};let n=c[0];if(!w(e,n))return{ok:!1,reason:`foundation順NG`};let r=S(n.suit);return{ok:!0,cards:[n],fromDetail:{type:`column`,colIndex:i,startIndex:o},toDetail:{type:`foundation`,foundationIndex:r},actionType:`MOVE_TO_FOUNDATION`}}return{ok:!1,reason:`to不明`}}if(t.type===`freecell`){if(t.index===void 0)return{ok:!1,reason:`freecell indexなし`};let r=t.index,i=e.freecells[r];if(!i)return{ok:!1,reason:`freecell空`};if(n.type===`column`){if(n.index===void 0)return{ok:!1,reason:`to column indexなし`};let t=e.columns[n.index],a=t&&t.length>0?t[t.length-1]:null;return ne(a,i)?{ok:!0,cards:[i],fromDetail:{type:`freecell`,freecellIndex:r},toDetail:{type:`column`,colIndex:n.index},actionType:`MOVE_CARD`}:{ok:!1,reason:`列に置けない`}}if(n.type===`foundation`){if(!w(e,i))return{ok:!1,reason:`foundation順NG`};let t=S(i.suit);return{ok:!0,cards:[i],fromDetail:{type:`freecell`,freecellIndex:r},toDetail:{type:`foundation`,foundationIndex:t},actionType:`MOVE_TO_FOUNDATION`}}return n.type===`freecell`?{ok:!1,reason:`freecell->freecell未対応`}:{ok:!1,reason:`to不明`}}if(t.type===`foundation`){if(t.index===void 0)return{ok:!1,reason:`foundation indexなし`};let r=t.index,i=e.foundations[r];if(!i||i.length===0)return{ok:!1,reason:`foundation空`};let a=i[i.length-1];if(n.type===`column`){if(n.index===void 0)return{ok:!1,reason:`to column indexなし`};let t=e.columns[n.index],i=t&&t.length>0?t[t.length-1]:null;return ne(i,a)?{ok:!0,cards:[a],fromDetail:{type:`foundation`,foundationIndex:r},toDetail:{type:`column`,colIndex:n.index},actionType:`MOVE_CARD`}:{ok:!1,reason:`列に戻せない`}}return n.type===`freecell`?{ok:!1,reason:`foundation->freecell未対応`}:n.type===`foundation`?{ok:!1,reason:`foundation->foundation無意味`}:{ok:!1,reason:`to不明`}}return{ok:!1,reason:`from不明`}}function oe(e){return{columns:e.columns.map(e=>e.slice()),freecells:e.freecells.slice(),foundations:e.foundations.map(e=>e.slice())}}function se(e){return(e.foundations[0]?.length||0)+(e.foundations[1]?.length||0)+(e.foundations[2]?.length||0)+(e.foundations[3]?.length||0)===52}function ce(e,t,n,r){let i=ae(e,t,n);if(!i.ok||!i.cards||!i.fromDetail||!i.toDetail||!i.actionType)return{ok:!1,reason:i.reason||`移動不可`,newState:e};let a=i.cards,o=oe(e);if(i.fromDetail.type===`column`){let e=i.fromDetail.colIndex,t=i.fromDetail.startIndex;o.columns[e].splice(t,a.length)}else if(i.fromDetail.type===`freecell`){let e=i.fromDetail.freecellIndex;o.freecells[e]=null}else if(i.fromDetail.type===`foundation`){let e=i.fromDetail.foundationIndex;o.foundations[e].pop()}else return{ok:!1,reason:`fromDetail.type不明`,newState:e};if(i.toDetail.type===`column`){let e=i.toDetail.colIndex,t=o.columns[e];for(let e of a)t.push(e)}else if(i.toDetail.type===`freecell`){let t=i.toDetail.freecellIndex;if(o.freecells[t]!==null)return{ok:!1,reason:`freecell競合`,newState:e};o.freecells[t]=a[0]}else if(i.toDetail.type===`foundation`){let e=a[0],t=S(e.suit);o.foundations[t].push(e)}else return{ok:!1,reason:`toDetail.type不明`,newState:e};let s={index:r,action:i.actionType,from:{type:i.fromDetail.type,colIndex:i.fromDetail.colIndex,startIndex:i.fromDetail.startIndex,freecellIndex:i.fromDetail.freecellIndex,foundationIndex:i.fromDetail.foundationIndex},to:{type:i.toDetail.type,colIndex:i.toDetail.colIndex,freecellIndex:i.toDetail.freecellIndex,foundationIndex:i.toDetail.foundationIndex},cards:a.map(e=>e.id)},c=se(o);return{ok:!0,newState:o,logEntry:s,cleared:c}}function le(e){return e===1?`A`:e===11?`J`:e===12?`Q`:e===13?`K`:String(e)}function ue(e){switch(e){case`H`:return`♥`;case`D`:return`♦`;case`C`:return`♣`;case`S`:return`♠`}return``}function de(e){return e.color===`red`?`card red`:`card black`}function fe(e,t,n,r,i,a,o,s){let c=document.createElement(`div`);c.className=de(e),n&&c.classList.add(`card-head`),r&&c.classList.add(`card-selected-outline`),c.style.top=`${t}px`,c.style.position=`absolute`;let l=document.createElement(`div`);l.className=`card-header`,l.textContent=ue(e.suit)+le(e.rank),c.appendChild(l);let u=document.createElement(`div`);return u.className=`card-center`,u.innerHTML=`
    <span class="center-suit">${ue(e.suit)}</span>
    <span class="center-rank">${le(e.rank)}</span>
  `,c.appendChild(u),n&&i?(c.addEventListener(`click`,e=>{e.stopPropagation(),o.onSelectSource(i)}),a&&c.addEventListener(`dblclick`,e=>{e.stopPropagation(),o.onAutoToFoundation(i)}),c.addEventListener(`pointerdown`,e=>{e.stopPropagation(),e.preventDefault(),o.onDragStart(i,e)})):s&&c.addEventListener(`click`,e=>{e.stopPropagation(),s()}),c}function pe(e,t,n,r,i,a,o,s,c){let l=t.state;e.innerHTML=``;let u=document.createElement(`div`);u.className=`game-root`;let d=document.createElement(`div`);d.className=`board-frame`,u.appendChild(d);let f=document.createElement(`div`);f.className=`top-bar`;let p=document.createElement(`div`);p.style.display=`flex`,p.style.gap=`8px`;let m=document.createElement(`button`);m.className=`back-btn`,m.textContent=`← メニュー`,m.addEventListener(`click`,()=>{c.onBackToMenu()}),p.appendChild(m);let h=document.createElement(`button`);h.className=`back-btn`,h.textContent=`NEW GAME`,h.addEventListener(`click`,()=>c.onNewGameClick()),p.appendChild(h);let g=document.createElement(`button`);if(g.className=`back-btn`,g.textContent=`UNDO`,g.addEventListener(`click`,()=>{c.onUndoClick()}),p.appendChild(g),(a||o)&&!s){let e=document.createElement(`button`);e.className=`back-btn finish-btn`,e.textContent=o?`FINISH中...`:`FINISH`,o?e.disabled=!0:e.addEventListener(`click`,()=>{c.onFinishClick()}),p.appendChild(e)}let _=document.createElement(`div`);_.textContent=n.statusText||``,_.style.marginLeft=`12px`,_.style.fontSize=`14px`,_.style.color=`#ffd27a`,_.style.display=`flex`,_.style.alignItems=`center`,_.style.whiteSpace=`nowrap`,p.appendChild(_),f.appendChild(p);let v=document.createElement(`div`);v.className=`info-box`;let y=document.createElement(`div`);y.textContent=`モード: ${t.mode}`,v.appendChild(y);let ee=document.createElement(`div`);ee.textContent=`レベル: ${t.level}`,v.appendChild(ee);let te=document.createElement(`div`);te.textContent=`シード: ${t.seed}`,v.appendChild(te),f.appendChild(v),d.appendChild(f);let b=document.createElement(`div`);b.className=`board freecell-board`;let x=document.createElement(`div`);x.className=`board-top-row`;let S=document.createElement(`div`);S.className=`freecell-group`,l.freecells.forEach((e,t)=>{let n=document.createElement(`div`);if(n.className=`slot freecell-slot-area`,n.dataset.drop=`freecell-${t}`,n.addEventListener(`click`,e=>{e.stopPropagation(),c.onClickDestination({destType:`freecell`,freecellIndex:t})}),e){let a=!!r.freecells[t],o=!!i.freecells[t],s=fe(e,0,a,o,a?{srcType:`freecell`,freecellIndex:t}:null,!0,c);S.appendChild(n),n.appendChild(s)}else S.appendChild(n)}),x.appendChild(S);let C=document.createElement(`div`);C.className=`foundation-group`,l.foundations.forEach((e,t)=>{let n=document.createElement(`div`);n.className=`slot foundation-slot-area`,n.dataset.drop=`foundation-${t}`,n.addEventListener(`click`,e=>{e.stopPropagation(),c.onClickDestination({destType:`foundation`,foundationIndex:t})});let a=e.length>0?e[e.length-1]:null;if(a){let e=!!r.foundations[t],o=!!i.foundations[t],s=fe(a,0,e,o,e?{srcType:`foundation`,foundationIndex:t}:null,!1,c);s.classList.add(`foundation-card`),C.appendChild(n),n.appendChild(s)}else C.appendChild(n)}),x.appendChild(C),b.appendChild(x);let w=document.createElement(`div`);if(w.className=`columns-area`,l.columns.forEach((e,t)=>{let n=document.createElement(`div`);n.className=`column-stack`,n.dataset.drop=`column-${t}`,n.addEventListener(`click`,e=>{e.stopPropagation(),c.onClickDestination({destType:`column`,colIndex:t})}),e.forEach((e,a)=>{let o=!!(r.columns[t]&&r.columns[t][a]),s=!!(i.columns[t]&&i.columns[t][a]),l=o?{srcType:`column`,colIndex:t,startIndex:a}:null,u=fe(e,a*20,o,s,l,!0,c,()=>{c.onColumnCardTap(t,a)});n.appendChild(u)}),w.appendChild(n)}),b.appendChild(w),b.addEventListener(`click`,()=>{c.onEmptyBoardClick()}),d.appendChild(b),n.showNewGameMenu&&!s){let e=document.createElement(`div`);e.className=`overlay`;let t=document.createElement(`div`);t.className=`overlay-panel`;let n=document.createElement(`div`);n.className=`overlay-title`,n.textContent=`NEW GAME`,t.appendChild(n);let r=document.createElement(`div`);r.className=`overlay-btn-wrap`;function i(e,t){let n=document.createElement(`button`);return n.textContent=e,n.className=`overlay-btn`,n.addEventListener(`click`,()=>{c.onChooseNewGameOption(t)}),n}r.appendChild(i(`同じ条件でもう一度`,`retry`)),r.appendChild(i(`レベル1`,`level1`)),r.appendChild(i(`レベル2`,`level2`)),r.appendChild(i(`レベル3`,`level3`)),r.appendChild(i(`キャンセル`,`cancel`)),t.appendChild(r),e.appendChild(t),u.appendChild(e)}if(s){let e=document.createElement(`div`);e.style.position=`fixed`,e.style.left=`0`,e.style.top=`0`,e.style.width=`100%`,e.style.height=`100%`,e.style.background=`rgba(0,0,0,0.7)`,e.style.display=`flex`,e.style.flexDirection=`column`,e.style.alignItems=`center`,e.style.justifyContent=`center`,e.style.zIndex=`99999`,e.style.color=`#00ff9c`,e.style.textAlign=`center`;let t=document.createElement(`style`);t.textContent=`
@keyframes pulseClear {
  0%   { text-shadow:0 0 10px #00ff9c,0 0 20px #00ff9c; }
  50%  { text-shadow:0 0 20px #ffffff,0 0 40px #00ff9c; }
  100% { text-shadow:0 0 10px #00ff9c,0 0 20px #00ff9c; }
}`,e.appendChild(t);let n=document.createElement(`div`);n.textContent=`CLEAR!`,n.style.fontSize=`64px`,n.style.fontWeight=`bold`,n.style.marginBottom=`24px`,n.style.animation=`pulseClear 1s infinite`,e.appendChild(n);let r=document.createElement(`div`);r.style.display=`flex`,r.style.flexDirection=`column`,r.style.gap=`12px`;function i(e,t){let n=document.createElement(`button`);return n.textContent=e,n.style.background=`#222`,n.style.border=`2px solid #00ff9c`,n.style.color=`#00ff9c`,n.style.borderRadius=`8px`,n.style.padding=`12px 20px`,n.style.fontSize=`18px`,n.style.cursor=`pointer`,n.addEventListener(`click`,t),n}let a=i(`メインメニューへ`,()=>{c.onClearToMenuClick()}),o=i(`もう一度`,()=>{c.onClearReplayClick()});r.appendChild(a),r.appendChild(o),e.appendChild(r),u.appendChild(e)}e.appendChild(u)}function D(e){return e.suit===`H`||e.suit===`D`?`red`:`black`}function me(e){return{stock:e.stock.map(e=>({...e})),waste:e.waste.map(e=>({...e})),foundations:e.foundations.map(e=>e.map(e=>({...e}))),tableaus:e.tableaus.map(e=>e.map(e=>({...e}))),drawCount:e.drawCount}}function he(e,t){for(let n=t;n<e.length;n++)if(!e[n].faceUp)return!1;for(let n=t;n<e.length-1;n++){let t=e[n],r=e[n+1];if(!t.faceUp||!r.faceUp||t.rank!==r.rank+1||D(t)===D(r))return!1}return!0}function ge(e,t,n){let r=e.tableaus[t];return!r||n<0||n>=r.length||!he(r,n)?[]:r.slice(n)}function _e(e,t){if(!t.length)return e.rank===1;let n=t[t.length-1];return e.suit===n.suit&&e.rank===n.rank+1}function ve(e,t){if(!t.length)return e.rank===13;let n=t[t.length-1];return!n.faceUp||D(e)===D(n)?!1:e.rank===n.rank-1}function ye(e){for(let t=0;t<e.foundations.length;t++)if(e.foundations[t].length!==13)return!1;return!0}function be(e,t,n,r){let i=me(e),a=[];if(t.type===`waste`){if(!i.waste.length)return{ok:!1,reason:`wasteが空`};let e=i.waste[i.waste.length-1];if(!e.faceUp)return{ok:!1,reason:`wasteが裏`};a=[e]}else if(t.type===`foundation`){let e=i.foundations[t.foundationIndex];if(!e.length)return{ok:!1,reason:`foundationが空`};a=[e[e.length-1]]}else{let e=i.tableaus[t.colIndex];if(!e)return{ok:!1,reason:`bad tableau col`};if(t.cardIndex<0||t.cardIndex>=e.length)return{ok:!1,reason:`bad cardIndex`};let n=ge(i,t.colIndex,t.cardIndex);if(!n.length)return{ok:!1,reason:`その位置からは動かせない`};a=n}if(n.type===`foundation`){let e=n.foundationIndex;if(a.length!==1)return{ok:!1,reason:`foundationへは1枚のみ`};let r=a[0],o=i.foundations[e];if(!_e(r,o))return{ok:!1,reason:`foundationに置けない`};if(t.type===`waste`)i.waste.pop();else if(t.type===`foundation`)return{ok:!1,reason:`foundation同士は不可`};else{i.tableaus[t.colIndex]=i.tableaus[t.colIndex].slice(0,t.cardIndex);let e=i.tableaus[t.colIndex];e.length>0&&(e[e.length-1].faceUp=!0)}return o.push(r),{ok:!0,newState:i,logEntry:{type:`move-to-foundation`,card:r},cleared:ye(i)}}if(n.type===`tableau`){let e=i.tableaus[n.colIndex];if(!e)return{ok:!1,reason:`bad dst tableau`};let r=a[0];if(!ve(r,e))return{ok:!1,reason:`tableauに置けない`};if(t.type===`waste`)i.waste.pop();else if(t.type===`foundation`)i.foundations[t.foundationIndex].pop();else{i.tableaus[t.colIndex]=i.tableaus[t.colIndex].slice(0,t.cardIndex);let e=i.tableaus[t.colIndex];e.length>0&&(e[e.length-1].faceUp=!0)}return e.push(...a),{ok:!0,newState:i,logEntry:{type:`move-to-tableau`,cards:a},cleared:ye(i)}}return{ok:!1,reason:`unknown dest`}}function xe(e){return e===1?`A`:e===11?`J`:e===12?`Q`:e===13?`K`:String(e)}function Se(e){return{H:`♥`,D:`♦`,C:`♣`,S:`♠`}[e]}function Ce(e){return e===`H`||e===`D`?`red`:`black`}function O(e,t,n,r,i){let a=e.selectedFrom;return a?t===`tableau`&&a.srcType===`tableau`?a.colIndex===n&&r>=a.cardIndex:t===`waste`&&a.srcType===`waste`?r===i-1:t===`foundation`&&a.srcType===`foundation`?a.foundationIndex===n&&r===i-1:!1:!1}function k(e,t,n,r,i,a,o){let s=document.createElement(`div`);if(!e.faceUp)s.className=`card back`;else{s.className=`card ${Ce(e.suit)}`;let t=document.createElement(`div`);t.className=`card-header`,t.textContent=Se(e.suit)+xe(e.rank),s.appendChild(t);let n=document.createElement(`div`);n.className=`card-center`,n.innerHTML=`
      <span class="center-suit">${Se(e.suit)}</span>
      <span class="center-rank">${xe(e.rank)}</span>
    `,s.appendChild(n)}return t&&s.classList.add(`card-selected-outline`),s.style.position=`absolute`,s.style.left=`${n}px`,s.style.top=`${r}px`,i&&e.faceUp&&(s.addEventListener(`click`,e=>{e.stopPropagation(),a.onSelectSource(i)}),o&&s.addEventListener(`dblclick`,e=>{e.stopPropagation(),a.onAutoToFoundation(i)}),s.addEventListener(`pointerdown`,e=>{e.stopPropagation(),a.onDragStart(i,e)})),s}function we(e,t){let n=document.createElement(`div`);n.className=`slot stock-slot`,n.style.position=`relative`,n.dataset.stock=`1`,n.addEventListener(`click`,e=>{e.stopPropagation(),t.onStockClick()});let r=e.stock.length;if(r>0){let e=document.createElement(`div`);e.className=`card back`,e.style.position=`absolute`,e.style.left=`0px`,e.style.top=`0px`,n.appendChild(e);let t=document.createElement(`div`);t.className=`stock-count`,t.textContent=String(r),n.appendChild(t)}return n}function Te(e,t,n){let r=e.waste.length,i=document.createElement(`div`);i.className=`slot waste-slot`,i.style.position=`relative`,i.style.height=`100px`;let a=72+27*Math.max(0,r-1);if(i.style.width=`${a}px`,r===0)return i;for(let a=0;a<r;a++){let o=e.waste[a],s=a===r-1,c=O(t,`waste`,0,a,r),l=s?{srcType:`waste`}:null,u=k(o,c,a*27,4,l,n,!0);u.style.transform=`scale(0.7)`,u.style.transformOrigin=`top left`,s&&o.faceUp&&(u.dataset.srcType=`waste`),i.appendChild(u)}return i}function Ee(e,t,n){let r=document.createElement(`div`);r.className=`foundation-group`;for(let i=0;i<e.foundations.length;i++){let a=e.foundations[i],o=document.createElement(`div`);if(o.className=`slot foundation-slot-area`,o.dataset.drop=`foundation-${i}`,o.addEventListener(`click`,e=>{e.stopPropagation(),n.onClickDestination({destType:`foundation`,foundationIndex:i})}),a.length>0){let e=a[a.length-1],r=O(t,`foundation`,i,a.length-1,a.length),s=k(e,r,0,0,{srcType:`foundation`,foundationIndex:i},n,!1);s.classList.add(`foundation-card`),s.dataset.srcType=`foundation`,s.dataset.foundationIndex=String(i),o.appendChild(s)}r.appendChild(o)}return r}function De(e,t,n){let r=document.createElement(`div`);r.className=`columns-area`;let i=e.tableaus;for(let e=0;e<i.length;e++){let a=i[e],o=document.createElement(`div`);o.className=`column-stack`,o.dataset.drop=`tableau-${e}`,o.addEventListener(`click`,t=>{t.target.closest(`.card`)||(t.stopPropagation(),n.onClickDestination({destType:`tableau`,colIndex:e}))});for(let r=0;r<a.length;r++){let i=a[r],s=r*24,c=O(t,`tableau`,e,r,a.length),l={srcType:`tableau`,colIndex:e,cardIndex:r},u=k(i,c,0,s,i.faceUp?l:null,n,!0);u.dataset.srcType=`tableau`,u.dataset.colIndex=String(e),u.dataset.cardIndex=String(r),o.appendChild(u)}r.appendChild(o)}return r}function Oe(e){let t=document.createElement(`div`);t.className=`overlay`;let n=document.createElement(`div`);n.className=`overlay-panel`;let r=document.createElement(`div`);r.className=`overlay-title`,r.textContent=`NEW GAME`,n.appendChild(r);let i=document.createElement(`div`);i.className=`overlay-btn-wrap`;function a(t,n){let r=document.createElement(`button`);return r.textContent=t,r.className=`overlay-btn`,r.addEventListener(`click`,()=>{e.onChooseNewGameOption(n)}),r}return i.appendChild(a(`同じ条件でもう一度`,`retry`)),i.appendChild(a(`レベル1`,`level1`)),i.appendChild(a(`レベル2`,`level2`)),i.appendChild(a(`レベル3`,`level3`)),i.appendChild(a(`キャンセル`,`cancel`)),n.appendChild(i),t.appendChild(n),t}function ke(e){let t=document.createElement(`div`);t.style.position=`fixed`,t.style.left=`0`,t.style.top=`0`,t.style.width=`100%`,t.style.height=`100%`,t.style.background=`rgba(0,0,0,0.7)`,t.style.display=`flex`,t.style.flexDirection=`column`,t.style.alignItems=`center`,t.style.justifyContent=`center`,t.style.zIndex=`99999`,t.style.color=`#00ff9c`,t.style.textAlign=`center`;let n=document.createElement(`style`);n.textContent=`
@keyframes pulseClear {
  0%   { text-shadow:0 0 10px #00ff9c,0 0 20px #00ff9c; }
  50%  { text-shadow:0 0 20px #ffffff,0 0 40px #00ff9c; }
  100% { text-shadow:0 0 10px #00ff9c,0 0 20px #00ff9c; }
}`,t.appendChild(n);let r=document.createElement(`div`);r.textContent=`CLEAR!`,r.style.fontSize=`64px`,r.style.fontWeight=`bold`,r.style.marginBottom=`24px`,r.style.animation=`pulseClear 1s infinite`,t.appendChild(r);let i=document.createElement(`div`);i.style.display=`flex`,i.style.flexDirection=`column`,i.style.gap=`12px`;function a(e,t){let n=document.createElement(`button`);return n.textContent=e,n.style.background=`#222`,n.style.border=`2px solid #00ff9c`,n.style.color=`#00ff9c`,n.style.borderRadius=`8px`,n.style.padding=`12px 20px`,n.style.fontSize=`18px`,n.style.cursor=`pointer`,n.addEventListener(`click`,t),n}let o=a(`メインメニューへ`,()=>{e.onClearToMenuClick()}),s=a(`もう一度`,()=>{e.onClearReplayClick()});return i.appendChild(o),i.appendChild(s),t.appendChild(i),t}function Ae(e,t,n,r,i,a,o){let s=t.state;e.innerHTML=``;let c=document.createElement(`div`);c.className=`game-root`;let l=document.createElement(`div`);l.className=`board-frame`,c.appendChild(l);let u=document.createElement(`div`);u.className=`top-bar`;let d=document.createElement(`div`);d.style.display=`flex`,d.style.gap=`8px`;{let e=document.createElement(`button`);e.className=`back-btn`,e.textContent=`← メニュー`,e.addEventListener(`click`,()=>o.onBackToMenu()),d.appendChild(e)}{let e=document.createElement(`button`);e.className=`back-btn`,e.textContent=`NEW GAME`,e.addEventListener(`click`,()=>o.onNewGameClick()),d.appendChild(e)}{let e=document.createElement(`button`);e.className=`back-btn`,e.textContent=`UNDO`,e.addEventListener(`click`,()=>o.onUndoClick()),d.appendChild(e)}{let e=document.createElement(`div`);e.className=`top-bar-log`,e.textContent=n.statusText||``,d.appendChild(e)}if((r||i)&&!a){let e=document.createElement(`button`);e.className=`back-btn finish-btn`,e.textContent=i?`FINISH中...`:`FINISH`,i?e.disabled=!0:e.addEventListener(`click`,()=>{o.onFinishClick()}),d.appendChild(e)}u.appendChild(d);let f=document.createElement(`div`);f.className=`info-box`,f.innerHTML=`
    <div>モード: ${t.mode}</div>
    <div>レベル: ${t.level}</div>
    <div>シード: ${t.seed}</div>
  `,u.appendChild(f),l.appendChild(u);let p=document.createElement(`div`);p.className=`board klondike-board`;let m=document.createElement(`div`);m.className=`board-top-row`;let h=document.createElement(`div`);h.className=`stock-waste-group`,h.appendChild(we(s,o));let g=Ee(s,n,o);m.appendChild(h),m.appendChild(g),p.appendChild(m);let _=document.createElement(`div`);_.className=`draw-row`,_.appendChild(Te(s,n,o)),p.appendChild(_);let v=De(s,n,o);p.appendChild(v),p.addEventListener(`click`,()=>{o.onEmptyBoardClick()}),l.appendChild(p),n.showNewGameMenu&&!a&&c.appendChild(Oe(o)),a&&c.appendChild(ke(o)),e.appendChild(c)}function je(e){return e===1?`A`:e===11?`J`:e===12?`Q`:e===13?`K`:String(e)}function Me(e){switch(e){case`H`:return`♥`;case`D`:return`♦`;case`C`:return`♣`;case`S`:return`♠`}return`?`}function Ne(e){return e===`H`||e===`D`?`red`:`black`}function Pe(e,t,n,r,i,a){let o=t.state;e.innerHTML=``;let s=document.createElement(`div`);s.className=`game-root`;let c=document.createElement(`div`);c.className=`board-frame`,s.appendChild(c);let l=document.createElement(`div`);l.className=`top-bar`;let u=document.createElement(`div`);u.style.display=`flex`,u.style.gap=`8px`;let d=document.createElement(`button`);d.className=`back-btn`,d.textContent=`← メニュー`,d.addEventListener(`click`,()=>a.onBackToMenu()),u.appendChild(d);let f=document.createElement(`button`);f.className=`back-btn`,f.textContent=`NEW GAME`,f.addEventListener(`click`,()=>a.onNewGameClick()),u.appendChild(f);let p=document.createElement(`button`);p.className=`back-btn`,p.textContent=`UNDO`,p.addEventListener(`click`,()=>a.onUndoClick()),u.appendChild(p);{let e=document.createElement(`div`);e.className=`top-bar-log`,e.textContent=n.statusText||``,u.appendChild(e)}l.appendChild(u);let m=document.createElement(`div`);m.className=`info-box`,m.innerHTML=`
    <div>モード: Spider</div>
    <div>レベル: ${t.level}</div>
    <div>シード: ${t.seed}</div>
  `,l.appendChild(m),c.appendChild(l);let h=document.createElement(`div`);h.className=`board spider-board`,h.addEventListener(`click`,e=>{e.target===h&&a.onEmptyBoardClick()});let g=document.createElement(`div`);g.className=`board-top-row`;{let e=document.createElement(`div`);e.className=`stock-waste-group`;let t=document.createElement(`div`);if(t.className=`slot`,t.dataset.drop=``,t.style.position=`relative`,t.style.cursor=`pointer`,o.stock&&o.stock.length>0){let e=Math.floor(o.stock.length/10),n=document.createElement(`div`);n.className=`stock-count`,n.textContent=`${e}回`,t.appendChild(n)}t.addEventListener(`click`,()=>{a.onStockClick()}),e.appendChild(t),g.appendChild(e)}{let e=document.createElement(`div`);e.className=`foundation-group`;let t=document.createElement(`div`);t.className=`slot spider-done`,t.style.cursor=`default`,t.style.color=`#00ff9c`,t.style.fontWeight=`700`,t.style.fontSize=`20px`,t.style.textAlign=`center`,t.style.lineHeight=`96px`,t.textContent=`${o.completedStacks}/8`,e.appendChild(t),g.appendChild(e)}h.appendChild(g);let _=document.createElement(`div`);if(_.className=`columns-area`,o.columns.forEach((e,t)=>{let i=document.createElement(`div`);i.className=`column-stack`,i.dataset.drop=`tableau-${t}`,i.addEventListener(`click`,r=>{if(r.target!==i)return;if(n.selectedFrom){a.onClickDestination({destType:`tableau`,colIndex:t});return}let o=e.length-1;o>=0?a.onColumnCardTap(t,o):a.onEmptyBoardClick()});let o=4;for(let n=0;n<e.length;n++){let s=e[n],c=s.faceUp,l=c?Ne(s.suit):`back`,u=document.createElement(`div`);if(u.className=`card ${l}`,u.style.top=o+`px`,u.style.left=`0px`,u.addEventListener(`pointerdown`,e=>{a.onDragStart({srcType:`tableau`,colIndex:t,cardIndex:n},e)}),u.addEventListener(`click`,e=>{e.stopPropagation(),a.onColumnCardTap(t,n)}),c){let e=document.createElement(`div`);e.className=`card-header`,e.textContent=Me(s.suit)+je(s.rank),u.appendChild(e);let t=document.createElement(`div`);t.className=`card-center`,t.innerHTML=`
          <span class="center-suit">${Me(s.suit)}</span>
          <span class="center-rank">${je(s.rank)}</span>
        `,u.appendChild(t)}let d=r.columns[t];d&&d[n]&&u.classList.add(`card-selected-outline`),i.appendChild(u),o+=c?24:16}_.appendChild(i)}),h.appendChild(_),c.appendChild(h),i||n.cleared){let e=document.createElement(`div`);e.className=`overlay`;let t=document.createElement(`div`);t.className=`overlay-panel`;let n=document.createElement(`div`);n.className=`overlay-title`,n.textContent=`クリア！`,t.appendChild(n);let r=document.createElement(`div`);r.className=`overlay-btn-wrap`;{let e=document.createElement(`button`);e.className=`overlay-btn`,e.textContent=`メインメニューへ`,e.addEventListener(`click`,()=>a.onClearToMenuClick()),r.appendChild(e)}{let e=document.createElement(`button`);e.className=`overlay-btn`,e.textContent=`同レベルをもう一度`,e.addEventListener(`click`,()=>a.onClearReplayClick()),r.appendChild(e)}t.appendChild(r),e.appendChild(t),s.appendChild(e)}if(n.showNewGameMenu&&!n.cleared&&!i){let e=document.createElement(`div`);e.className=`overlay`;let t=document.createElement(`div`);t.className=`overlay-panel`;let n=document.createElement(`div`);n.className=`overlay-title`,n.textContent=`NEW GAME`,t.appendChild(n);let r=document.createElement(`div`);r.className=`overlay-btn-wrap`;{let e=document.createElement(`button`);e.className=`overlay-btn`,e.textContent=`同じ条件でもう一度`,e.addEventListener(`click`,()=>a.onChooseNewGameOption(`retry`)),r.appendChild(e)}{let e=document.createElement(`button`);e.className=`overlay-btn`,e.textContent=`レベル1`,e.addEventListener(`click`,()=>a.onChooseNewGameOption(`level1`)),r.appendChild(e);let t=document.createElement(`button`);t.className=`overlay-btn`,t.textContent=`レベル2`,t.addEventListener(`click`,()=>a.onChooseNewGameOption(`level2`)),r.appendChild(t);let n=document.createElement(`button`);n.className=`overlay-btn`,n.textContent=`レベル3`,n.addEventListener(`click`,()=>a.onChooseNewGameOption(`level3`)),r.appendChild(n)}{let e=document.createElement(`button`);e.className=`overlay-btn`,e.textContent=`キャンセル`,e.addEventListener(`click`,()=>a.onChooseNewGameOption(`cancel`)),r.appendChild(e)}t.appendChild(r),e.appendChild(t),s.appendChild(e)}e.appendChild(s)}function Fe(e,t,n){e.innerHTML=``;let r=document.createElement(`div`);r.className=`menu-screen`;let i=document.createElement(`h1`);i.className=`menu-title`,i.textContent=`ソリティア`,r.appendChild(i);let a=document.createElement(`div`);if(a.className=`menu-subtitle`,a.textContent=`遊びたいゲームを選んでください`,r.appendChild(a),!t){let t=document.createElement(`div`);t.className=`menu-list`;{let e=document.createElement(`button`);e.className=`menu-btn active`,e.textContent=`フリーセル`,e.addEventListener(`click`,()=>{n.onSelectMode(`freecell`)}),t.appendChild(e)}{let e=document.createElement(`button`);e.className=`menu-btn active`,e.textContent=`クロンダイク`,e.addEventListener(`click`,()=>{n.onSelectMode(`klondike`)}),t.appendChild(e)}{let e=document.createElement(`button`);e.className=`menu-btn active`,e.textContent=`スパイダー`,e.addEventListener(`click`,()=>{n.onSelectMode(`spider`)}),t.appendChild(e)}r.appendChild(t),e.appendChild(r);return}let o=document.createElement(`div`);o.className=`menu-mode-label`,o.textContent=`モード: ${t}`,r.appendChild(o);let s=document.createElement(`div`);s.className=`menu-list`;{let e=document.createElement(`button`);e.className=`menu-btn active`,e.textContent=`レベル1`,e.addEventListener(`click`,()=>{n.onStartGame(t,1)}),s.appendChild(e)}{let e=document.createElement(`button`);e.className=`menu-btn active`,e.textContent=`レベル2`,e.addEventListener(`click`,()=>{n.onStartGame(t,2)}),s.appendChild(e)}{let e=document.createElement(`button`);e.className=`menu-btn active`,e.textContent=`レベル3`,e.addEventListener(`click`,()=>{n.onStartGame(t,3)}),s.appendChild(e)}r.appendChild(s);let c=document.createElement(`button`);c.className=`menu-back-btn`,c.textContent=`← ゲーム選択に戻る`,c.addEventListener(`click`,()=>{n.onBackModeSelect()}),r.appendChild(c),e.appendChild(r)}function Ie(){try{let e=localStorage.getItem(`ClearSeedStore`);if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function Le(e){try{localStorage.setItem(`ClearSeedStore`,JSON.stringify(e))}catch{}}var Re=Ie(),A=`menu`,j=void 0,M=null,N={selectedFrom:void 0,statusText:``,cleared:!1,showNewGameMenu:!1},P=!1,F=null,I={active:!1,mode:null,fromRef:null,stackCards:[],ghostEl:null,moved:!1,offsetX:0,offsetY:0};function ze(e){return e===1?`A`:e===11?`J`:e===12?`Q`:e===13?`K`:String(e)}function Be(e){switch(e){case`H`:return`♥`;case`D`:return`♦`;case`C`:return`♣`;case`S`:return`♠`}return``}function Ve(e){return e===`H`||e===`D`?`red`:`black`}function He(e){let t=document.createElement(`div`);return t.style.position=`fixed`,t.style.zIndex=`9999`,t.style.pointerEvents=`none`,t.style.left=`0px`,t.style.top=`0px`,t.style.width=`72px`,t.style.height=100+(e.length-1)*20+`px`,e.forEach((e,n)=>{let r=document.createElement(`div`);r.className=`card ${e.color} drag-ghost`,r.style.position=`absolute`,r.style.left=`0px`,r.style.top=`${n*20}px`,r.style.pointerEvents=`none`;let i=document.createElement(`div`);i.className=`card-header`,i.textContent=Be(e.suit)+ze(e.rank),r.appendChild(i);let a=document.createElement(`div`);a.className=`card-center`,a.innerHTML=`
      <span class="center-suit">${Be(e.suit)}</span>
      <span class="center-rank">${ze(e.rank)}</span>
    `,r.appendChild(a),t.appendChild(r)}),t}function Ue(e){return{columns:e.columns.map(e=>e.slice()),freecells:e.freecells.slice(),foundations:e.foundations.map(e=>e.slice())}}function We(e){let t=0;for(let n=0;n<e.foundations.length;n++)t+=e.foundations[n].length;return t===52}function L(e,t){let n={H:t[0].length,D:t[1].length,C:t[2].length,S:t[3].length},r=e.rank;if(r<=2)return!0;if(e.color===`red`){let e=Math.min(n.S,n.C);return r<=e+1}else{let e=Math.min(n.H,n.D);return r<=e+1}}function Ge(e){let t=Ue(e);for(;;){let e=!1;for(let n=0;n<t.freecells.length;n++){let r=t.freecells[n];if(r&&w(t,r)&&L(r,t.foundations)){t.freecells[n]=null,t.foundations[S(r.suit)].push(r),e=!0;break}}if(!e){for(let n=0;n<t.columns.length;n++){let r=t.columns[n];if(!r.length)continue;let i=r[r.length-1];if(w(t,i)&&L(i,t.foundations)){r.pop(),t.foundations[S(i.suit)].push(i),e=!0;break}}if(!e)break}}return We(t)}function Ke(){if(!M)return!1;let e=M.state;for(let t=0;t<e.freecells.length;t++){let n=e.freecells[t];if(n&&w(e,n)&&L(n,e.foundations)&&R({srcType:`freecell`,freecellIndex:t},{destType:`foundation`}).ok)return!0}for(let t=0;t<e.columns.length;t++){let n=e.columns[t];if(!n.length)continue;let r=n[n.length-1];if(w(e,r)&&L(r,e.foundations)){let e={srcType:`column`,colIndex:t,startIndex:n.length-1};if(R(e,{destType:`foundation`}).ok)return!0}}return!1}function qe(e){return e.srcType===`column`?{type:`column`,index:e.colIndex,startIndex:e.startIndex}:e.srcType===`freecell`?{type:`freecell`,index:e.freecellIndex}:{type:`foundation`,index:e.foundationIndex}}function Je(e){return e.destType===`column`?{type:`column`,index:e.colIndex}:e.destType===`freecell`?{type:`freecell`,index:e.freecellIndex}:{type:`foundation`,index:e.foundationIndex}}function R(e,t){if(!M)return{ok:!1,reason:`no session`};let n=qe(e),r=Je(t),i=ce(M.state,n,r,M.turnIndex);if(!i.ok)return N.statusText=`移動NG: `+i.reason,$(),{ok:!1,reason:i.reason};if(M.snapshot(),M.state=i.newState,M.recordMove(i.logEntry),i.cleared&&!N.cleared){U(),N.cleared=!0,N.statusText=`クリア！`,H(M);let e=M.buildClearReport(!0);console.log(`CLEAR REPORT:`,e)}else N.cleared||(N.statusText=`移動OK`);return N.selectedFrom=void 0,$(),{ok:!0}}function Ye(e,t){if(t.srcType===`column`){let n=E(e,t.colIndex,t.startIndex);if(!n.length)return[];let r=T(e);return n.length>r?[]:n}if(t.srcType===`freecell`){let n=e.freecells[t.freecellIndex];return n?[n]:[]}if(t.srcType===`foundation`){let n=e.foundations[t.foundationIndex];return n.length?[n[n.length-1]]:[]}return[]}function Xe(e,t){let n=document.elementFromPoint(e,t);for(;n&&!n.dataset?.drop;)n=n.parentElement;if(!n||!n.dataset.drop)return null;let[r,i]=n.dataset.drop.split(`-`),a=i===void 0?void 0:parseInt(i,10);return r===`column`&&a!==void 0?{destType:`column`,colIndex:a}:r===`freecell`&&a!==void 0?{destType:`freecell`,freecellIndex:a}:r===`foundation`?{destType:`foundation`,foundationIndex:a}:null}function Ze(e){return!!e.faceUp}function Qe(e){return e.srcType===`tableau`?{type:`tableau`,colIndex:e.colIndex,cardIndex:e.cardIndex}:e.srcType===`waste`?{type:`waste`}:{type:`foundation`,foundationIndex:e.foundationIndex}}function $e(e){return e.destType===`tableau`?{type:`tableau`,colIndex:e.colIndex}:{type:`foundation`,foundationIndex:e.foundationIndex}}function z(e,t){if(!M)return{ok:!1,reason:`no session`};let n=be(M.state,Qe(e),$e(t),M.turnIndex);if(!n.ok||!n.newState)return N.statusText=`移動NG: `+(n.reason||``),$(),{ok:!1,reason:n.reason};if(M.snapshot(),M.state=n.newState,n.logEntry&&M.recordMove(n.logEntry),n.cleared&&!N.cleared){U(),N.cleared=!0,N.statusText=`クリア！`,H(M);let e=M.buildClearReport(!0);console.log(`CLEAR REPORT:`,e)}else N.cleared||(N.statusText=`移動OK`);return N.selectedFrom=void 0,$(),{ok:!0}}function et(e,t){if(t.srcType===`waste`){let t=e.waste;if(!t.length)return[];let n=t[t.length-1];return Ze(n)?[n]:[]}if(t.srcType===`foundation`){let n=e.foundations[t.foundationIndex];return n.length?[n[n.length-1]]:[]}return ge(e,t.colIndex,t.cardIndex)}function tt(e,t){let n=document.elementFromPoint(e,t);for(;n&&!n.dataset?.drop;)n=n.parentElement;if(!n||!n.dataset.drop)return null;let[r,i]=n.dataset.drop.split(`-`),a=i===void 0?void 0:parseInt(i,10);return r===`tableau`&&a!==void 0?{destType:`tableau`,colIndex:a}:r===`foundation`&&a!==void 0?{destType:`foundation`,foundationIndex:a}:null}function nt(e){if(!M)return;let t=M.state;for(let n=0;n<t.foundations.length;n++)if(z(e,{destType:`foundation`,foundationIndex:n}).ok)return;N.statusText=`移動NG: foundationへ置けない`,$()}function rt(e){for(let t=0;t<e.tableaus.length;t++){let n=e.tableaus[t];for(let e=0;e<n.length;e++)if(!n[e].faceUp)return!1}return!0}function it(e){let t=0;for(let n=0;n<e.foundations.length;n++)t+=e.foundations[n].length;return t===52}function at(e){let t=e.stock.length===0,n=e.waste.length===0,r=rt(e);return t&&n&&r}function ot(e,t){return e.srcType===`tableau`&&t.srcType===`tableau`&&e.colIndex===t.colIndex&&e.cardIndex===t.cardIndex}function B(e,t){if(!t||t.srcType!==`tableau`)return[];let n=e.columns[t.colIndex];if(!n)return[];let r=t.cardIndex;if(r<0||r>=n.length)return[];let i=n[r];if(!i.faceUp)return[];let a=i.suit,o=i.rank,s=[i];for(let e=r+1;e<n.length;e++){let t=n[e];if(!t.faceUp||t.suit!==a||t.rank!==o-1)return[];s.push(t),o=t.rank}return s}function st(e,t){if(t.length===0)return!1;if(e.length===0)return!0;let n=e[e.length-1];return n.faceUp?t[0].rank===n.rank-1:!1}function ct(e,t){let n=e.slice(t);return e.splice(t,n.length),n}function lt(e){if(e.length===0)return;let t=e[e.length-1];t.faceUp||=!0}function ut(e,t){let n=document.elementFromPoint(e,t);for(;n&&!n.dataset?.drop;)n=n.parentElement;if(!n||!n.dataset.drop)return null;let[r,i]=n.dataset.drop.split(`-`),a=i===void 0?void 0:parseInt(i,10);return r===`tableau`&&a!==void 0?{destType:`tableau`,colIndex:a}:null}function dt(e,t){if(!M)return{ok:!1,reason:`no session`};if(M.mode!==`spider`)return{ok:!1,reason:`not spider`};if((window.spiderAnim||{active:!1,timer:null}).active)return N.statusText=`今は回収中でございます`,$(),{ok:!1,reason:`anim`};let n=M.state;if(!e||e.srcType!==`tableau`||!t||t.destType!==`tableau`)return N.statusText=`移動NG: 対応していない移動でございます`,$(),{ok:!1,reason:`bad ref`};let r=e.colIndex,i=e.cardIndex,a=t.colIndex;if(r===a)return N.statusText=`同じ列でございます`,$(),{ok:!1,reason:`same column`};let o=n.columns[r],s=n.columns[a];if(!o||!s)return N.statusText=`移動NG: 列が不正でございます`,$(),{ok:!1,reason:`bad column`};let c=B(n,{srcType:`tableau`,colIndex:r,cardIndex:i});if(!c.length)return N.statusText=`動かせない束でございます`,$(),{ok:!1,reason:`no movable seq`};if(!st(s,c))return N.statusText=`その列には置けません`,$(),{ok:!1,reason:`cant place`};M.snapshot();let l=ct(o,i);for(let e=0;e<l.length;e++)s.push(l[e]);return lt(o),N.selectedFrom=void 0,N.cleared=!1,N.statusText=`移動OK`,M.recordMove({type:`spiderMove`,fromColIndex:r,fromStartIdx:i,toColIndex:a,movedLen:l.length}),$(),V(),{ok:!0}}function ft(e){let t=!e.stock||e.stock.length===0,n=e.columns.every(e=>e.length===0);return t&&n}function pt(){if(!M||M.mode!==`spider`)return;let e=M.state;if((window.spiderAnim||{active:!1,timer:null}).active){N.statusText=`回収中でございます`,$();return}if(e.columns.some(e=>e.length===0)){N.statusText=`空の列があるので配れません`,$();return}if(!e.stock||e.stock.length<10){N.statusText=`山札なし`,$();return}M.snapshot();for(let t=0;t<10;t++){let n=e.stock.pop();if(!n)break;n.faceUp=!0,e.columns[t].push(n)}N.selectedFrom=void 0,N.cleared=!1,N.statusText=`山札を配りました`,M.recordMove({type:`spiderDeal`}),$(),V()}function mt(e){for(let t=0;t<e.columns.length;t++){let n=e.columns[t];if(n.length<13)continue;let r=n.length-13,i=n[r].suit,a=!0;for(let e=0;e<13;e++){let t=n[r+e],o=13-e;if(!t.faceUp){a=!1;break}if(t.suit!==i){a=!1;break}if(t.rank!==o){a=!1;break}}if(a)return{colIndex:t,startIdx:r}}return null}function ht(e){let t=document.querySelector(`[data-drop="tableau-${e}"]`);t&&(t.classList.add(`spider-column-flash`),setTimeout(()=>{t.classList.remove(`spider-column-flash`)},300))}function V(){if(!M||M.mode!==`spider`)return;let e=M.state,t=window.spiderAnim||(window.spiderAnim={active:!1,timer:null});if(t.active)return;let n=mt(e);if(!n){if(ft(e)&&!N.cleared){U(),N.cleared=!0,N.statusText=`クリア！`,H(M);let e=M.buildClearReport(!0);console.log(`CLEAR REPORT:`,e),$()}return}let{colIndex:r,startIdx:i}=n;t.active=!0;function a(){if(!M||M.mode!==`spider`)t.active=!1;else{let e=M.state,n=e.columns[r];lt(n),e.completedStacks++,$(),ht(r),t.active=!1,t.timer=null,setTimeout(()=>{V()},100)}}function o(){if(!t.active){t.timer=null;return}if(!M||M.mode!==`spider`){t.active=!1,t.timer=null;return}let e=M.state.columns[r];if(e.length<=i){t.timer=null,a();return}e.pop(),$(),t.timer=window.setTimeout(o,50)}o()}window.spiderAnim=window.spiderAnim||{active:!1,timer:null},window.spiderAfterMutation=V;function gt(e,t){let n={};if(!t||t.srcType!==`tableau`)return{columns:n};let r=t.colIndex,i=B(e,t);if(!i.length)return{columns:n};let a=t.cardIndex,o=a+i.length-1;for(let e=a;e<=o;e++)n[r]||(n[r]={}),n[r][e]=!0;return{columns:n}}function _t(e,t){if(N.cleared||!M||M.mode!==`spider`)return;let n=M.state,r=n.columns[e];if(!r||!r.length){N.selectedFrom=void 0,N.statusText=`動かせない`,$();return}let i;for(let a=t;a<r.length;a++)if(B(n,{srcType:`tableau`,colIndex:e,cardIndex:a}).length>0){i=a;break}if(i===void 0){N.selectedFrom=void 0,N.statusText=`動かせない`,$();return}N.selectedFrom={srcType:`tableau`,colIndex:e,cardIndex:i},N.statusText=`列${e}を選択中`,$()}function H(e){let t=e.buildClearReport(!0),n={seed:e.seed,mode:e.mode,level:e.level,report:t,timestamp:Date.now()};Re.push(n),Le(Re),console.log(`[ClearSeed保存]`,n)}function vt(){if(!M||M.mode!==`klondike`)return!1;let e=M.state;for(let t=0;t<e.tableaus.length;t++){let n=e.tableaus[t];if(!n.length)continue;let r=n.length-1;if(!n[r].faceUp)continue;let i={srcType:`tableau`,colIndex:t,cardIndex:r};for(let t=0;t<e.foundations.length;t++)if(z(i,{destType:`foundation`,foundationIndex:t}).ok)return!0}return!1}function yt(){M&&(P||N.cleared||M.mode!==`spider`&&(P=!0,N.statusText=`自動回収中…`,$(),F=window.setInterval(()=>{if(!M){U();return}let e=!1;e=M.mode===`freecell`?Ke():M.mode===`klondike`?vt():!1,e?$():bt()},100)))}function U(){F!==null&&(clearInterval(F),F=null),P=!1}function bt(){F!==null&&(clearInterval(F),F=null);let e=M&&xt(M);if(P=!1,M)if(e&&!N.cleared){N.cleared=!0,N.statusText=`クリア！`,H(M);let e=M.buildClearReport(!0);console.log(`CLEAR REPORT:`,e)}else e||(N.statusText=`自動回収完了`);$()}function xt(e){return e.mode===`freecell`?We(e.state):e.mode===`klondike`?it(e.state):e.mode===`spider`?ft(e.state):!1}function St(e){if(N.cleared||P)return!1;if(e.mode===`freecell`)return Ge(e.state);if(e.mode===`klondike`){let t=e.state;return at(t)}else if(e.mode===`spider`)return!1;return!1}function Ct(e,t){return e.srcType===t.srcType?e.srcType===`column`?t.srcType===`column`&&e.colIndex===t.colIndex&&e.startIndex===t.startIndex:e.srcType===`freecell`?t.srcType===`freecell`&&e.freecellIndex===t.freecellIndex:t.srcType===`foundation`&&e.foundationIndex===t.foundationIndex:!1}function wt(e,t){return e.srcType===t.srcType?e.srcType===`waste`?t.srcType===`waste`:e.srcType===`foundation`?t.srcType===`foundation`&&e.foundationIndex===t.foundationIndex:t.srcType===`tableau`&&e.colIndex===t.colIndex&&e.cardIndex===t.cardIndex:!1}function W(e){if(N.cleared||!M)return;let t=!1;if(M.mode===`freecell`?N.selectedFrom&&(t=Ct(N.selectedFrom,e)):M.mode===`klondike`?N.selectedFrom&&(t=wt(N.selectedFrom,e)):M.mode===`spider`&&N.selectedFrom&&(t=ot(N.selectedFrom,e)),t){N.selectedFrom=void 0,N.statusText=`選択解除`,$();return}if(N.selectedFrom=e,M.mode===`freecell`){let t=e;t.srcType===`column`?N.statusText=`列${t.colIndex}を選択中`:t.srcType===`freecell`?N.statusText=`フリーセル${t.freecellIndex}を選択中`:N.statusText=`foundation${t.foundationIndex}を選択中`}else if(M.mode===`klondike`){let t=e;t.srcType===`tableau`?N.statusText=`列${t.colIndex}を選択中`:t.srcType===`waste`?N.statusText=`wasteを選択中`:N.statusText=`foundation${t.foundationIndex}を選択中`}else{let t=e;t.srcType===`tableau`?N.statusText=`列${t.colIndex}を選択中`:N.statusText=`選択中`}$()}function G(e){if(M&&N.selectedFrom&&!N.cleared){if(M.mode===`freecell`){R(N.selectedFrom,e).ok||(N.selectedFrom=void 0,$());return}if(M.mode===`klondike`){z(N.selectedFrom,e).ok||(N.selectedFrom=void 0,$());return}if(M.mode===`spider`){dt(N.selectedFrom,e).ok||(N.selectedFrom=void 0,$());return}}}function K(){N.selectedFrom&&(N.selectedFrom=void 0,N.statusText=`選択解除`,$())}function q(e,t){if(!M||I.active||N.cleared)return;let n=[];if(M.mode===`freecell`?n=Ye(M.state,e):M.mode===`klondike`?n=et(M.state,e):M.mode===`spider`&&(n=B(M.state,e)),!n.length)return;t.preventDefault();let r=n.map(e=>({rank:e.rank,suit:e.suit,color:Ve(e.suit)})),i=He(r);i.style.left=t.clientX+`px`,i.style.top=t.clientY+`px`,document.body.appendChild(i),I={active:!0,mode:M.mode,fromRef:e,stackCards:r,ghostEl:i,moved:!1,offsetX:36,offsetY:50},window.addEventListener(`pointermove`,Tt),window.addEventListener(`pointerup`,Et)}function Tt(e){if(!I.active||!I.ghostEl)return;e.preventDefault(),I.moved=!0;let t=e.clientX-I.offsetX,n=e.clientY-I.offsetY;I.ghostEl.style.left=t+`px`,I.ghostEl.style.top=n+`px`}function Et(e){if(I.active){if(window.removeEventListener(`pointermove`,Tt),window.removeEventListener(`pointerup`,Et),I.ghostEl&&I.ghostEl.parentElement&&I.ghostEl.parentElement.removeChild(I.ghostEl),I.moved&&M&&I.mode===M.mode){if(M.mode===`freecell`){let t=Xe(e.clientX,e.clientY);t?R(I.fromRef,t):(N.statusText=`移動NG: ドロップ先なし`,$())}else if(M.mode===`klondike`){let t=tt(e.clientX,e.clientY);t?z(I.fromRef,t):(N.statusText=`移動NG: ドロップ先なし`,$())}else if(M.mode===`spider`){let t=ut(e.clientX,e.clientY);t?dt(I.fromRef,t):(N.statusText=`移動NG: ドロップ先なし`,$())}}I={active:!1,mode:null,fromRef:null,stackCards:[],ghostEl:null,moved:!1,offsetX:0,offsetY:0}}}function Dt(e){M&&(M.mode===`freecell`?R(e,{destType:`foundation`}):M.mode===`klondike`&&nt(e))}function Ot(){if(!M||M.mode!==`klondike`)return;M.snapshot();let e=M.state,t=M.level>=3?3:1;if(!e.stock||e.stock.length===0)if(e.waste&&e.waste.length>0){for(;e.waste.length>0;){let t=e.waste.pop();t&&(t.faceUp=!1,e.stock.push(t))}N.statusText=`山札をリサイクル`}else N.statusText=`山札なし`;else{let n=0;for(let r=0;r<t&&e.stock.length;r++){let t=e.stock.pop();if(!t)break;t.faceUp=!0,e.waste.push(t),n++}N.statusText=n>0?`山札から${n}枚ドロー`:`山札なし`}N.selectedFrom=void 0,N.cleared=!1,$()}function J(){if(!M)return;U();let e=window.spiderAnim;e&&e.active&&(e.active=!1,e.timer!=null&&(clearTimeout(e.timer),e.timer=null)),M.undo()?(N.selectedFrom=void 0,N.cleared=!1,N.statusText=`1手戻した`,$()):(N.statusText=`戻せない`,$())}function Y(){M&&(U(),N.showNewGameMenu=!0,$())}function kt(e){if(!M){N.showNewGameMenu=!1,$();return}let t=M.mode,n=M.level,r=null;if(e===`cancel`){N.showNewGameMenu=!1,$();return}e===`retry`?(r=M.seed,n=M.level):e===`level1`?n=1:e===`level2`?n=2:e===`level3`&&(n=3),r===null&&(r=Math.floor(Math.random()*2**32)),U();let i=window.spiderAnim;i&&(i.active=!1,i.timer!=null&&(clearTimeout(i.timer),i.timer=null)),M=new x(t,n,r),N={selectedFrom:void 0,statusText:``,cleared:!1,showNewGameMenu:!1},A=`game`,$()}function At(e,t){U();let n=window.spiderAnim;n&&(n.active=!1,n.timer!=null&&(clearTimeout(n.timer),n.timer=null));let r=Math.floor(Math.random()*2**32);M=new x(e,t,r),N={selectedFrom:void 0,statusText:``,cleared:!1,showNewGameMenu:!1},A=`game`,$()}function X(){U();let e=window.spiderAnim;e&&(e.active=!1,e.timer!=null&&(clearTimeout(e.timer),e.timer=null)),A=`menu`,N={selectedFrom:void 0,statusText:``,cleared:!1,showNewGameMenu:!1},M=null,j=void 0,$()}function Z(){X()}function jt(){if(!M){X();return}let e=M.mode;U();let t=window.spiderAnim;t&&(t.active=!1,t.timer!=null&&(clearTimeout(t.timer),t.timer=null)),A=`menu`,M=null,N={selectedFrom:void 0,statusText:``,cleared:!1,showNewGameMenu:!1},j=e,$()}function Mt(){let e=document.getElementById(`app`);if(!e)return;let t=document.getElementById(`felt-wrapper`);t||(t=document.createElement(`div`),t.id=`felt-wrapper`,t.style.position=`fixed`,t.style.inset=`0`,t.style.overflow=`hidden`,document.body.appendChild(t));let n=document.getElementById(`game-scale-wrapper`);n||(n=document.createElement(`div`),n.id=`game-scale-wrapper`,n.style.position=`fixed`,n.style.left=`50%`,n.style.top=`0`,n.style.transformOrigin=`top center`,t.appendChild(n)),e.parentElement!==n&&n.appendChild(e)}var Nt=1e3,Pt=800;function Ft(){let e=window.innerWidth,t=window.innerHeight,n=e/Nt,r=t/Pt,i=Math.min(1,n,r),a=Nt*i,o=Math.max((e-a)/2,0),s=document.documentElement.style;s.setProperty(`--app-scale`,i.toString()),s.setProperty(`--stage-left`,`${o}px`)}function Q(){requestAnimationFrame(Ft)}window.addEventListener(`resize`,Ft),window.addEventListener(`orientationchange`,Ft);function $(){Mt();let e=document.getElementById(`app`);if(!e)throw Error(`#app が見つからない`);if(A===`menu`){Fe(e,j,{onSelectMode:e=>{j=e,$()},onBackModeSelect:()=>{j=void 0,$()},onStartGame:(e,t)=>{At(e,t)}}),Q();return}if(A===`game`){if(!M)throw Error(`sessionが無いのにgame画面`);let t=xt(M),n=!!N.cleared||t,r=St(M);if(M.mode===`freecell`){let t=M.state,i=T(t),a={};t.columns.forEach((e,n)=>{if(e.length)for(let r=0;r<e.length;r++){let e=E(t,n,r);e.length&&e.length<=i&&(a[n]||(a[n]={}),a[n][r]=!0)}});let o={columns:a,freecells:(()=>{let e={};return t.freecells.forEach((t,n)=>{t&&(e[n]=!0)}),e})(),foundations:(()=>{let e={};return t.foundations.forEach((t,n)=>{t.length>0&&(e[n]=!0)}),e})()},s={},c={},l={};if(N.selectedFrom&&N.selectedFrom.srcType){let e=N.selectedFrom;if(e.srcType===`column`){let n=E(t,e.colIndex,e.startIndex);if(n.length>0&&n.length<=i)for(let t=0;t<n.length;t++){let n=e.startIndex+t;s[e.colIndex]||(s[e.colIndex]={}),s[e.colIndex][n]=!0}}else e.srcType===`freecell`?c[e.freecellIndex]=!0:e.srcType===`foundation`&&(l[e.foundationIndex]=!0)}pe(e,M,N,o,{columns:s,freecells:c,foundations:l},r,P,n,{onBackToMenu:()=>X(),onUndoClick:()=>J(),onFinishClick:()=>yt(),onNewGameClick:()=>Y(),onChooseNewGameOption:e=>kt(e),onClearToMenuClick:()=>Z(),onClearReplayClick:()=>jt(),onSelectSource:e=>W(e),onColumnCardTap:(e,t)=>{if(N.cleared||!M)return;let n=M.state,r=n.columns[e];if(!r.length)return;let i=[];for(let t=0;t<r.length;t++){let r=E(n,e,t);r.length&&r.length<=T(n)&&i.push(t)}if(!i.length){N.selectedFrom=void 0,N.statusText=`動かせない`,$();return}let a=i.find(e=>e>=t);a===void 0&&(a=i[i.length-1]),N.selectedFrom={srcType:`column`,colIndex:e,startIndex:a},N.statusText=`列${e}を選択中`,$()},onClickDestination:e=>G(e),onAutoToFoundation:e=>Dt(e),onDragStart:(e,t)=>q(e,t),onEmptyBoardClick:()=>K()}),Q();return}if(M.mode===`klondike`){Ae(e,M,N,r,P,n,{onBackToMenu:()=>X(),onUndoClick:()=>J(),onFinishClick:()=>yt(),onNewGameClick:()=>Y(),onChooseNewGameOption:e=>kt(e),onClearToMenuClick:()=>Z(),onClearReplayClick:()=>jt(),onSelectSource:e=>W(e),onClickDestination:e=>G(e),onAutoToFoundation:e=>Dt(e),onDragStart:(e,t)=>q(e,t),onEmptyBoardClick:()=>K(),onStockClick:()=>Ot()}),Q();return}if(M.mode===`spider`){let t=M.state,r=gt(t,N.selectedFrom);Pe(e,M,N,r,n,{onBackToMenu:()=>X(),onUndoClick:()=>J(),onNewGameClick:()=>Y(),onChooseNewGameOption:e=>kt(e),onClearToMenuClick:()=>Z(),onClearReplayClick:()=>jt(),onSelectSource:e=>W(e),onColumnCardTap:(e,t)=>_t(e,t),onClickDestination:e=>G(e),onDragStart:(e,t)=>q(e,t),onStockClick:()=>pt(),onEmptyBoardClick:()=>K()}),Q();return}e.innerHTML=`<div style="color:#fff">未実装モード: ${M?.mode}</div>`,Q();return}}$();